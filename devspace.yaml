version: v1beta11
vars:
  - name: APP
    value: myreads
  - name: IMAGE
    value: pratikjagrut/myreads
  - name: DB
    value: mariadb
images:
  default:
    image: ${IMAGE}
deployments:
- name: configurations
  kubectl:
    manifests:
    - manifests/
- name: ${DB}
  helm:
    componentChart: true
    values:
      containers:
      - env:
        - name: MARIADB_ROOT_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: ${DB}-configmap
              key: MARIADB_ROOT_PASSWORD
        - name: MARIADB_DATABASE
          valueFrom:
            configMapKeyRef:
              name: ${DB}-configmap
              key: MARIADB_DATABASE
        - name: MARIADB_USER
          valueFrom:
            configMapKeyRef:
              name: ${DB}-configmap
              key: MARIADB_USER 
        - name: MARIADB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: ${DB}-configmap
              key: MARIADB_PASSWORD 
        image: mariadb:latest
        volumeMounts:
        - containerPath: /var/lib/${APP}
          volume:
            name: ${APP}-data
            subPath: /${APP}
      service:
        name: ${DB}-service
        ports:
        - port: 3306
      volumes:
      - name: ${APP}-data
        size: 5Gi
- name: ${APP}-backend
  helm:
    componentChart: true
    values:
      containers:
      - image: ${IMAGE}
        env:
        - name: DB_HOST
          value: ${DB}-service
        - name: DB_PORT
          value: "3306"
        - name: DB_NAME
          value: ${APP}
        - name: DB_USER
          valueFrom:
            configMapKeyRef:
              name: ${DB}-configmap
              key: MARIADB_USER 
        - name: DB_PASS
          valueFrom:
            configMapKeyRef:
              name: ${DB}-configmap
              key: MARIADB_PASSWORD
      service:
        ports:
        - port: 80
dev:
  ports:
  - imageSelector: ${IMAGE}
    forward:
    - port: 8080
      remotePort: 80
  # sync:
  # - imageName: ${IMAGE}
